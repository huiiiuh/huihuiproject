## RBAC 框架文档

> 一般系统都需要进行权限控制，所以构造了一个基于 Django REST Framework 框架通用基于角色的权限认证系统 

### 系统模块

- 用户认证
  - [x] 用户登录
  - [x] 用户注销
  - [x] 修改密码
  - [x] 密码重置
  - [x] 更新用户状态
- 用户管理
  - [x] 创建用户
  - [x] 用户列表
  - [x] 用户详情
  - [x] 修改用户
  - [x] 删除用户
- 角色管理
  - [x] 创建角色
  - [x] 角色列表
  - [x] 角色详情
  - [x] 修改角色
  - [x] 删除角色
- 权限管理（支持父子权限）
  - [x] 权限列表
  - [x] 初始化权限基础信息
    
## 目录结构
- commons：系统工具类和方法
  
  - config: 加载配置工具类
  - exc: 全局异常捕获和自定义异常类
  - globals: 系统常量和枚举
  - http: 封装全局响应处理类
  - log: 加载日志
  - stat: 全局状态信息
  - utils: 通用工具类（jwt认证、密码处理、字段校验等）
    
    - drf_helper: Django REST Framework 帮助类(认证、权限、分页)
- conf: 全局配置文件存放目录
  
- logs: 系统的日志存放目录
  
- middlewares: 中间件

- rbac: django配置根路径, 根路由
  
- v1/rbac_app
  
   - routers: 路由分发（user、roles、privilege、others）
   - serializers: 业务逻辑
   - views: 控制层
  
- .gitignore: git忽略文件

- manager.py: 系统入口，主服务启动文件
  
- rbac.sqlite3: 数据库文件
  
- db.sqlite3: 数据库文件
  
- requirements.txt: 系统依赖第三方库

## 数据库结构设计
用户表

| 字段名          | 说明             | 类型     | 长度 | 可空 | 默认值  |
| :-------------- | :--------------- | :------- | :--- | :--- | :------ |
| id              | 用户id           | integer  | ——   | 否   | ——      |
| username        | 用户名           | varchar  | 32   | 否   | ——      |
| password        | 密码             | varchar  | 128  | 否   | ——      |
| nickname        | 昵称             | varchar  | 16   | 是   | ——      |
| avatar          | 头像             | varchar  | 100  | 否   | ——      |
| phone           | 手机号码         | varchar  | 11   | 否   | ——      |
| email           | 邮箱             | varchar  | 64   | 否   | ——      |
| status          | 状态             | smallint | ——   | 否   | 1: 激活 |
| is_email_notify | 是否启用邮箱通知 | bool     | ——   | 否   | false   |
| is_sms_notify   | 是否启动短信通知 | bool     | ——   | 否   | false   |
| is_login        | 是否登录         | bool     | ——   | 否   | false   |
| create_user     | 创建人           | integer  | ——   | 是   | ——      |
| update_user     | 更新人           | integer  | ——   | 是   | ——      |
| create_time     | 创建时间         | integer  | ——   | 否   | ——      |
| update_time     | 更新时间         | integer  | ——   | 否   | ——      |



角色表

| 字段名      | 说明     | 类型    | 长度 | 可空 | 默认值 | 取值范围 |
| :---------- | :------- | :------ | :--- | :--- | :----- | :------- |
| id          | 角色id   | integer | ——   | 否   | ——     | ——       |
| name        | 角色名称 | varchar | 10   | 否   | ——     | ——       |
| create_user | 创建人   | integer | ——   | 是   | ——     | ——       |
| update_user | 更新人   | integer | ——   | 是   | ——     | ——       |
| create_time | 创建时间 | integer | ——   | 否   | ——     | ——       |
| update_time | 更新时间 | integer | ——   | 否   | ——     | ——       |



权限表

| 字段名        | 说明     | 类型     | 长度 | 可空 | 默认值 |
| :------------ | :------- | :------- | :--- | :--- | :----- |
| id            | 权限id   | integer  | ——   | 否   | ——     |
| tItle         | 权限标题 | varchar  | 16   | 否   | ——     |
| privilege_key | 权限key  | varchar  | 50   | 否   | ——     |
| method        | 请求方法 | smallint | ——   | 否   | ——     |
| route         | 请求url  | varchar  | 255  | 否   | ——     |
| pid           | 父权限ID | integer  | ——   | 是   | ——     |



用户角色表

| 字段名      | 说明     | 类型    | 长度 | 可空 | 默认值 | 取值范围 |
| :---------- | :------- | :------ | :--- | :--- | :----- | :------- |
| id          | id       | integer | ——   | 否   | ——     | ——       |
| user_id     | 用户ID   | integer | ——   | 否   | ——     | ——       |
| role_id     | 角色ID   | integer | ——   | 否   | ——     | ——       |
| create_user | 创建人   | integer | ——   | 是   | ——     | ——       |
| update_user | 更新人   | integer | ——   | 是   | ——     | ——       |
| create_time | 创建时间 | integer | ——   | 否   | ——     | ——       |
| update_time | 更新时间 | integer | ——   | 否   | ——     | ——       |



角色权限表

| 字段名       | 说明     | 类型    | 长度 | 可空 | 默认值 | 取值范围 |
| :----------- | :------- | :------ | :--- | :--- | :----- | :------- |
| id           | id       | integer | ——   | 否   | ——     | ——       |
| privilege_id | 权限ID   | integer | ——   | 否   | ——     | ——       |
| role_id      | 角色ID   | integer | ——   | 否   | ——     | ——       |
| create_user  | 创建人   | integer | ——   | 是   | ——     | ——       |
| update_user  | 更新人   | integer | ——   | 是   | ——     | ——       |
| create_time  | 创建时间 | integer | ——   | 否   | ——     | ——       |
| update_time  | 更新时间 | integer | ——   | 否   | ——     | ——       |
## 使用说明

## 注意事项





---

## 扩展

> RBAC：基于角色的权限访问控制（`Role-Base-Access Control`）

**从RBAC0到RBAC3分别需要5到12张表**

### RBAC0

> RBAC0是RBAC中的基础模型，后续的模型都是RBAC0的改进
>
> RBAC0引入了角色概念来解决用户与权限之间的分离问题，用户实际上没有权限,而只有给用户赋予某种角色之后，才拥有相应的权限.
>
> RBAC0主要解决了权限的分离问题

数据表模型:

我们需要5张表来完成RBAC0

分别是:

1. 用户表(User)

   字段：用户名、密码

2. 角色表(Role)

   字段：角色名、角色父ID

3. 权限表(Permission)

   字段：权限名、类方法名、权限父ID

4. 权限角色关联表(PA)  -> 多对多

   字段：角色ID、权限ID

5. 用户角色关联表(UA) -> 多对多

   字段：用户ID，角色ID

总结：现在我们实现了一个基本的RBAC0的基础模型

### RBAC1

> 我们来对以上模型加以改进:
>
> 当用户数量过多的时候，我们需要引入用户组的概念。角色不仅可以对用户进行关联，也可以对用户组进行关联，所现在我们需要添加三张表

添加以下三张表

6. 用户组表(UserGroup)
7. 用户组角色关联表(UGA)
8. 用户组与用户关联表(UUG)

> 在公司中,我们还有所谓的上下级关系，一个部门部长下面要管理副部长、经理等等。这时我们就要引入角色的继承关系来表示上下级关系，体现在数据表上，就要添加一张角色继承表

9. 角色继承关系表

总结：到了这一步我们基本上实现了RBAC1的标准规范

### RBAC2

> 而在角色的继承中，我们其实对继承的角色权限也要加以控制，毕竟不可能让继承过来的角色拥有父角色的所有权限，所以就需要多加一张对来对继承的角色进行权限约束。

10.角色权限约束

我们除了对角色进行约束，其实还可以对用户来进行一些相关的约束来更好的保证整个系统的责任链分离，如果你也添加了用户的约束规则，那么我们就基本上达到了RBAC2的规范了

### RBAC3

11.用户激活约束

在这个基础上，我们再来看看权限授权这一部分

这时候,如果我们需要判定的功能权限太多，那么就可以将权限划分模块，然后统一将角色授权给某个模块.

12.权限模块表

13.权限模块与权限关联表

14.角色与模块的关系表

15.操作表

16.资源表

总结：到了这一步我们基本上实现了RBAC3的标准规范

